FROM paulgauthier/aider-full:latest

###############################################################################
# 1) Switch to root so we can install packages
###############################################################################
USER root

###############################################################################
# 2) Install core packages (git, fzf, neovim, ripgrep, build-essential, etc.)
###############################################################################
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      curl \
      git \
      fzf \
      neovim \
      ripgrep \
      build-essential \
      ca-certificates

###############################################################################
# 3) Install Lazygit from GitHub releases
###############################################################################
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": *"v\K[^"]*') && \
    curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" && \
    tar -C /tmp -xf /tmp/lazygit.tar.gz lazygit && \
    install /tmp/lazygit /usr/local/bin/lazygit && \
    rm /tmp/lazygit.tar.gz /tmp/lazygit

###############################################################################
# 4) Install Node.js (version 18.x) 
###############################################################################
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

###############################################################################
# 5) (Optional) Clone the LazyVim starter config
###############################################################################
RUN git clone https://github.com/LazyVim/starter ~/.config/nvim

###############################################################################
# 6) Set the default working directory
###############################################################################
WORKDIR /app

###############################################################################
# 7) Switch back to the non-root user from the Aider image (usually "aider")
#    If you prefer to remain root, comment this out.
###############################################################################
USER 1000

###############################################################################
# 8) Default command is to open a bash shell
###############################################################################
CMD ["/bin/bash"]
